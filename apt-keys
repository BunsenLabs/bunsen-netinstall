# This file is sourced by the install script just before installing
# the main packages.
# You can add code to install APT GPG keys here.
#
# LOGGING:
# bigmsg "..." will output a bold message to the terminal and logfile.
# End your command lines with:
#  > >( tee -a "$logfile" ) 2>&1 || giveup "Some message..." 1
# so that output will be logged, and success checked.

readonly BUNSEN_APT_FINGERPRINT=3172478405227490BBB743E6A0673F72FE62D9C5
readonly BUNSEN_APT_KEY_URL="http://pkg.bunsenlabs.org/BunsenLabs-RELEASE.asc"
readonly LOCAL_KEY_FILE=./BunsenLabs-Release.asc

bigmsg "Installing BunsenLabs APT key."

if ! wget -O "$LOCAL_KEY_FILE" "$BUNSEN_APT_KEY_URL"; then
  giveup "Failed to retrieve the remote PGP key." 1
fi

readonly BUNSEN_APT_LOCAL_FINGERPRINT=$(gpg --with-fingerprint "$LOCAL_KEY_FILE" | grep '^\s\+Key'| cut -d= -f2 | tr -d ' ')

if [[ "$BUNSEN_APT_FINGERPRINT" != "$BUNSEN_APT_LOCAL_FINGERPRINT" ]]; then
  giveup "Local and remote PGP keys do not match: Invalid key!" 1
fi

if ! sudo apt-key add "$LOCAL_KEY_FILE"; then
  giveup "Failed to install the signing key." 1
fi
